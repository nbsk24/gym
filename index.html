<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Фитнес Трекер Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* ... (предыдущие стили остаются без изменений) ... */
        
        .password-reset-form {
            display: none;
        }
        
        .export-import {
            margin: 20px 0;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: 8px;
        }
        
        .email-confirmation {
            color: var(--secondary-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .not-confirmed {
            color: var(--danger-color);
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Формы аутентификации -->
    <div id="auth-forms">
        <div class="auth-container" id="login-form">
            <h2>Вход</h2>
            <form class="auth-form" onsubmit="login(event)">
                <input type="text" id="login-username" placeholder="Имя пользователя" required>
                <input type="password" id="login-password" placeholder="Пароль" required>
                <button type="submit">Войти</button>
            </form>
            <div class="auth-switch" onclick="showRegisterForm()">Нет аккаунта? Зарегистрируйтесь</div>
            <div class="auth-switch" onclick="showResetForm()">Забыли пароль?</div>
        </div>
        
        <div class="auth-container" id="register-form" style="display: none;">
            <h2>Регистрация</h2>
            <form class="auth-form" onsubmit="register(event)">
                <input type="text" id="register-username" placeholder="Имя пользователя" required>
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="password" id="register-password" placeholder="Пароль" required>
                <input type="password" id="register-confirm" placeholder="Подтвердите пароль" required>
                <button type="submit">Зарегистрироваться</button>
            </form>
            <div class="auth-switch" onclick="showLoginForm()">Уже есть аккаунт? Войдите</div>
        </div>
        
        <div class="auth-container password-reset-form" id="reset-form">
            <h2>Восстановление пароля</h2>
            <form class="auth-form" onsubmit="sendResetLink(event)">
                <input type="email" id="reset-email" placeholder="Ваш email" required>
                <button type="submit">Отправить ссылку</button>
            </form>
            <div class="auth-switch" onclick="showLoginForm()">Вернуться к входу</div>
        </div>
    </div>
    
    <!-- Основное приложение -->
    <div class="container" id="app-container">
        <div class="user-header">
            <div class="user-info">
                Привет, <span id="current-user"></span>!
                <div class="email-confirmation" id="email-confirmation-status"></div>
            </div>
            <button class="logout-btn" onclick="logout()">Выйти</button>
        </div>
        
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('tracker')">Трекер</div>
            <div class="tab" onclick="switchTab('stats')">Статистика</div>
<div class="tab" onclick="switchTab('settings')">Настройки</div>
        </div>
        
        <div class="tab-content active" id="tracker-tab">
            <!-- ... (ваш существующий код трекера) ... -->
        </div>
        
        <div class="tab-content" id="stats-tab">
            <!-- Графики прогресса -->
            <div class="chart-container">
                <h3 class="chart-title">Прогресс по месяцам (текущий год)</h3>
                <canvas id="monthly-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="chart-title">Прогресс по годам</h3>
                <canvas id="yearly-chart"></canvas>
            </div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="export-import">
                <h3>Экспорт/Импорт данных</h3>
                <button onclick="exportData()">Экспорт всех данных</button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
                <button onclick="document.getElementById('import-file').click()">Импорт данных</button>
                <p>Экспортированные данные содержат все ваши тренировки в JSON формате</p>
            </div>
            
            <div class="export-import">
                <h3>Смена пароля</h3>
                <input type="password" id="current-password" placeholder="Текущий пароль">
                <input type="password" id="new-password" placeholder="Новый пароль">
                <button onclick="changePassword()">Сменить пароль</button>
            </div>
            
            <div class="export-import">
                <h3>Подтверждение email</h3>
                <p id="current-email"></p>
                <button onclick="sendConfirmationEmail()">Отправить подтверждение</button>
                <div id="confirmation-result"></div>
            </div>
        </div>
    </div>

    <script>
        // Хеширование паролей с солью
        function hashPassword(password, salt) {
            return CryptoJS.PBKDF2(password, salt, {
                keySize: 256/32,
                iterations: 1000
            }).toString();
        }
        
        // Генерация соли
        function generateSalt() {
            return CryptoJS.lib.WordArray.random(128/8).toString();
        }
        
        // Система аутентификации с email подтверждением
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('workoutUsers')) || {};
        let confirmationTokens = JSON.parse(localStorage.getItem('confirmationTokens')) || {};
        
        // Функция отправки email (эмуляция)
        function sendEmail(to, subject, body) {
            console.log(`Email to: ${to}\nSubject: ${subject}\nBody: ${body}`);
            // В реальном приложении здесь будет вызов API отправки email
        }
        
        // Восстановление пароля
        function sendResetLink(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            let userFound = null;
            
            for (const username in users) {
                if (users[username].email === email) {
                    userFound = username;
                    break;
                }
            }
            
            if (!userFound) {
                alert('Пользователь с таким email не найден!');
                return;
            }
            
            const token = generateToken();
            confirmationTokens[token] = {
                username: userFound,
                type: 'password_reset',
                expires: Date.now() + 3600000 // 1 час
            };
            
            localStorage.setItem('confirmationTokens', JSON.stringify(confirmationTokens));
            
            const resetLink = `${window.location.origin}${window.location.pathname}?token=${token}`;
            sendEmail(
                email,
                'Восстановление пароля',
                `Для сброса пароля перейдите по ссылке: ${resetLink}`
);
            
            alert('Ссылка для сброса пароля отправлена на ваш email!');
            showLoginForm();
        }
        
        // Обработка токена при загрузке страницы
        function processToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token && confirmationTokens[token]) {
                const tokenData = confirmationTokens[token];
                
                if (tokenData.expires < Date.now()) {
                    alert('Ссылка устарела!');
                    return;
                }
                
                if (tokenData.type === 'password_reset') {
                    const newPassword = prompt('Введите новый пароль:');
                    if (newPassword) {
                        const salt = generateSalt();
                        users[tokenData.username].passwordHash = hashPassword(newPassword, salt);
                        users[tokenData.username].salt = salt;
                        localStorage.setItem('workoutUsers', JSON.stringify(users));
                        delete confirmationTokens[token];
                        localStorage.setItem('confirmationTokens', JSON.stringify(confirmationTokens));
                        alert('Пароль успешно изменён!');
                    }
                } else if (tokenData.type === 'email_confirmation') {
                    users[tokenData.username].emailConfirmed = true;
                    localStorage.setItem('workoutUsers', JSON.stringify(users));
                    delete confirmationTokens[token];
                    localStorage.setItem('confirmationTokens', JSON.stringify(confirmationTokens));
                    alert('Email успешно подтверждён!');
                    if (currentUser === tokenData.username) {
                        updateEmailConfirmationStatus();
                    }
                }
                
                // Удаляем токен из URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        // Подтверждение email
        function sendConfirmationEmail() {
            if (!currentUser || !users[currentUser].email) return;
            
            const token = generateToken();
            confirmationTokens[token] = {
                username: currentUser,
                type: 'email_confirmation',
                expires: Date.now() + 86400000 // 24 часа
            };
            
            localStorage.setItem('confirmationTokens', JSON.stringify(confirmationTokens));
            
            const confirmLink = `${window.location.origin}${window.location.pathname}?token=${token}`;
            sendEmail(
                users[currentUser].email,
                'Подтверждение email',
                `Для подтверждения email перейдите по ссылке: ${confirmLink}`
            );
            
            document.getElementById('confirmation-result').textContent = 'Письмо с подтверждением отправлено!';
        }
        
        // Генерация токена
        function generateToken() {
            return CryptoJS.lib.WordArray.random(32).toString();
        }
        
        // Экспорт данных
        function exportData() {
            if (!currentUser) return;
            
            const data = {
                workouts: workoutData,
                userInfo: users[currentUser]
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout-data-${currentUser}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Импорт данных
        document.getElementById('import-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (confirm('Заменить текущие данные импортируемыми? Все существующие данные будут потеряны!')) {
                        workoutData = data.workouts || {};
                        saveUserData();
                        alert('Данные успешно импортированы!');
                        location.reload();
                    }
                } catch (error) {
                    alert('Ошибка при чтении файла: ' + error.message);
                }
            };
            reader.readAsText(file);
        });
        
        // Обновление статуса подтверждения email
        function updateEmailConfirmationStatus() {
            if (!currentUser || !users[currentUser].email) return;
            
            const statusEl = document.getElementById('email-confirmation-status');
            statusEl.textContent = users[currentUser].email 
                ? `Email: ${users[currentUser].email} (${users[currentUser].emailConfirmed ? 'подтверждён' : 'не подтверждён'})`
                : 'Email не указан';
            
            if (users[currentUser].email && !users[currentUser].emailConfirmed) {
                statusEl.classList.add('not-confirmed');
            } else {
                statusEl.classList.remove('not-confirmed');
            }
            
            document.getElementById('current-email').textContent = users[currentUser].email || 'Email не указан';
        }
        
        // Переключение вкладок
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // При загрузке страницы
        window.addEventListener('DOMContentLoaded', function() {
            processToken();
            showLoginForm();
        });
    </script>
</body>
</html>
